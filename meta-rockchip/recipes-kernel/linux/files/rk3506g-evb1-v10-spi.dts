// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright (c) 2024 Rockchip Electronics Co., Ltd.
 * SPI Display Configuration for RK3506G EVB
 * Display: ILI9341 controller, 320x240 resolution, 2.8 inch
 */

/dts-v1/;

#include "rk3506.dtsi"
#include "rk3506-evb1-v10.dtsi"

/ {
	model = "Rockchip RK3506G(QFN128) EVB1 V10 Board + ILI9341 SPI Display";
	compatible = "rockchip,rk3506g-evb1-v10-spi", "rockchip,rk3506";

	chosen {
		bootargs = "earlycon=uart8250,mmio32,0xff0a0000,115200 console=ttyFIQ0,115200 storagemedia=sd root=/dev/mmcblk0p3 rootfstype=ext4 rw rootwait";
	};

	extcon_usb: extcon-usb {
		compatible = "linux,extcon-usb-gpio";
		vbus-gpio = <&gpio1 RK_PC5 GPIO_ACTIVE_LOW>;
		pinctrl-names = "default";
		pinctrl-0 = <&usb_extcon_vbus>;
		status = "okay";
	};

	vcc5v0_otg0: vcc5v0-otg0-regulator {
		compatible = "regulator-fixed";
		regulator-name = "vcc5v0_otg0";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		enable-active-high;
		gpio = <&gpio1 RK_PC4 GPIO_ACTIVE_HIGH>;
		vin-supply = <&vcc_sys>;
		regulator-state-mem {
			regulator-off-in-suspend;
		};
	};

	/* SPI Display Power Supply */
	vcc3v3_lcd: vcc3v3-lcd {
		compatible = "regulator-fixed";
		regulator-name = "vcc3v3_lcd";
		regulator-boot-on;
		regulator-always-on;
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		status = "okay";
	};

	/* Backlight for SPI Display - GPIO controlled */
	backlight: backlight {
		compatible = "gpio-backlight";
		gpios = <&gpio1 RK_PD1 GPIO_ACTIVE_HIGH>;
		power-supply = <&vcc3v3_lcd>;
		default-on;
		status = "okay";
	};
};

&cma {
	size = <0x1600000>;
};

/* Enable SPI0 Controller */
&spi0 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&spi0m0_pins>;
	max-freq = <48000000>;

	/* ILI9341 SPI Display */
	display@0 {
		compatible = "ilitek,ili9341";
		reg = <0>;
		
		/* SPI Configuration */
		spi-max-frequency = <32000000>;  /* 32MHz SPI clock for ILI9341 */
		
		/* GPIO Configuration */
		/* D/C (Data/Command) pin - GPIO1_C7 */
		dc-gpios = <&gpio1 RK_PC7 GPIO_ACTIVE_HIGH>;
		
		/* RESET pin - GPIO1_C5 */
		reset-gpios = <&gpio1 RK_PC5 GPIO_ACTIVE_LOW>;
		
		/* Backlight */
		backlight = <&backlight>;
		
		/* Power supply */
		power-supply = <&vcc3v3_lcd>;
		
		/* Display properties (2.8 inch, 320x240) */
		width-mm = <43>;   /* Physical width in mm */
		height-mm = <57>;  /* Physical height in mm */
		
		/* Panel timing (320x240 resolution) */
		panel-timing {
			hactive = <320>;
			vactive = <240>;
			hback-porch = <0>;
			hfront-porch = <0>;
			vback-porch = <0>;
			vfront-porch = <0>;
			hsync-len = <0>;
			vsync-len = <0>;
			hsync-active = <0>;
			vsync-active = <0>;
			de-active = <0>;
			pixelclk-active = <0>;
		};
		
		/* Display rotation (0, 90, 180, 270) */
		rotation = <0>;
		
		/* RGB format */
		format = <0x66>; /* RGB666 */
		
		status = "okay";
	};
};

/* USB OTG Configuration */
&u2phy_otg0 {
	rockchip,vbus-always-on;
};

&usbdrd30 {
	status = "okay";
};

&usbdrd_dwc3_0 {
	status = "okay";
	dr_mode = "otg";
	extcon = <&extcon_usb>;
};

&usbhost {
	status = "okay";
};

&usbhost_dwc2 {
	status = "okay";
};

/* I2C for touch controller or other peripherals (optional) */
&i2c2 {
	status = "okay";
	clock-frequency = <400000>;
};

/* Pin Control */
&pinctrl {
	usb {
		usb_extcon_vbus: usb-extcon-vbus {
			rockchip,pins = <1 RK_PC5 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};
	
	/* SPI display GPIOs */
	spi_display {
		/* D/C pin - GPIO1_C7 */
		spi_display_dc: spi-display-dc {
			rockchip,pins = <1 RK_PC7 RK_FUNC_GPIO &pcfg_pull_none>;
		};
		
		/* RESET pin - GPIO1_C5 */
		spi_display_rst: spi-display-rst {
			rockchip,pins = <1 RK_PC5 RK_FUNC_GPIO &pcfg_pull_up>;
		};
		
		/* LED Backlight - GPIO1_D1 */
		spi_display_led: spi-display-led {
			rockchip,pins = <1 RK_PD1 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};
};

